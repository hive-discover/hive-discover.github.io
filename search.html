<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="assets/img/Logo/icon_only.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        Hive Discover - Search
    </title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
        name='viewport' />
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css"
        integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <!-- CSS Files -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/hover-effect.css" rel="stylesheet" />
    <link href="assets/css/loading-animator.css" rel="stylesheet" />
    <link href="assets/css/now-ui-kit.css?v=1.3.0" rel="stylesheet" />
</head>

<body class="login-page sidebar-collapse">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-primary fixed-top navbar-transparent " color-on-scroll="400">
        <div class="container">
            <div class="navbar-translate">
                <a class="navbar-brand" href="/" rel="tooltip">
                    Hive Discover
                </a>
                <button class="navbar-toggler navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navigation" aria-controls="navigation-index" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-bar top-bar"></span>
                    <span class="navbar-toggler-bar middle-bar"></span>
                    <span class="navbar-toggler-bar bottom-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse justify-content-end" id="navigation"
                data-nav-image="../assets/img/blurred-image-1.jpg">
                <ul class="navbar-nav">
                    <li class="nav-item" id="nav_item_link_feed">
                        <a class="nav-link" href="/feed.html">
                            <i class="fas fa-rss-square"></i>
                            <p class="d-lg-none d-xl-none">Feed</p>
                        </a>
                    </li>
                    <li class="nav-item" id="nav_item_link_account">
                        <a class="nav-link" href="/account.html">
                            <i class="fa fa-user"></i>
                            <p class="d-lg-none d-xl-none">Your Account</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="javascript:openSettingsModal();">
                            <i class="fa fa-cog"></i>
                            <p class="d-lg-none d-xl-none">Settings</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" rel="tooltip" title="View on GitHub" data-placement="bottom"
                            href="https://github.com/Hive-Discover" target="_blank">
                            <i class="fab fa-github"></i>
                            <p class="d-lg-none d-xl-none">Github</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- End Navbar -->
    <div class="wrapper">
        <div class="page-header clear-filter" filter-color="orange">
            <div class="content">
                <div class="container">
                    <div class="row">
                        <div class="col-md-8 ml-auto mr-auto text-center">
                            <h2 class="title">
                                Search
                                <br />
                                <a class="btn btn-round btn-secondary" id="btn_select_authors"
                                    href="javascript: setup_wishes(false);">Author</a>
                                <a class="btn btn-round btn-info" id="btn_select_posts"
                                    href="javascript: setup_wishes(true);">Posts</a>
                                <hr />
                            </h2>
                        </div>
                    </div>
                    <div>
                        <h5>Select at least two categories to begin: </h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" id="choose_drop_category">Category</button>
                            <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="sr-only">Toggle Dropdown</span>
                            </button>
                            <div class="dropdown-menu" style="overflow: scroll; max-height: 350px;"
                                id="dropdown_list_categories">
                              <!--  <a class="dropdown-item" href="javascript:setzero_dropdown('action');">Action</a>-->
                            </div>
                        </div>
                        <br /><br />

                        <div class="row" id="choosed_categories_first">
                            <!--  <div class="card col-md-2 text-center" style="margin: auto">
                                <div class="card-body">
                                    <h6 style="color: black;">
                                        Category
                                        <a style="color: blue;" href="">X</a>
                                    </h6>
                                </div>
                            </div> -->
                        </div>
                        <br />
                        <div class="row" id="choosed_categories_second">
                            <!--  <div class="card col-md-2 text-center" style="margin: auto">
                                <div class="card-body">
                                    <h6 style="color: black;">
                                        Category
                                        <a style="color: blue;" href="">X</a>
                                    </h6>
                                </div>
                            </div> -->
                        </div>
                        <br /> <br />
                        <!-- Loading Animator -->
                        <div id="loading_animation" style="display: none;">
                            <div class="lds-roller">
                                <div></div>
                                <div></div>
                                <div></div>
                                <div></div>
                                <div></div>
                                <div></div>
                                <div></div>
                                <div></div>
                            </div>
                            <p>Loading</p>
                        </div>
                        <h6 id="lbl_cannot_find" style="display: none;">Cannot find any posts</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="section" id="terms">
            <div class="container">
                <div id="list">Nothing currently selected</div>
            </div>
        </div>
    </div>

    <!-- Post Holder -->
    <div id="post_holder" style="display: none">
        <div class="card clickable">
            <div class="card-body">
                <table>
                    <tr>
                        <th>
                            <span style="display: inline-block; height: 77px; width: 130px">
                                <picture style="width: 100%">
                                    <img src="{{ImageSource}}" onclick="OpenInNewTab('{{HiveURL}}');"
                                        style="display: inline-block; max-height: 100%; max-width: 100%" />
                                </picture>
                                <br />
                                <a href="https://hive.blog/@{{Author}}" target="_blank">{{Author}}</a>
                            </span>
                        </th>
                        <th onclick="OpenInNewTab('{{HiveURL}}');">
                            <div>
                                <h4 class="card-title"
                                    style="overflow: hidden; display: -webkit-box; text-overflow: ellipsis; -webkit-line-clamp: 1; -webkit-box-orient: vertical; color: black">
                                    {{Title}}
                                </h4>
                                <p class="card-text"
                                    style="overflow: hidden; display: -webkit-box; text-overflow: ellipsis; -webkit-line-clamp: 3; -webkit-box-orient: vertical; color: black;">
                                    {{Body}}
                                </p>
                            </div>
                        </th>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Author Holder -->
    <div id="author_holder" style="display: none">
        <div class="card clickable" onclick="OpenInNewTab('{{ProfileURL}}');">
            <div class="card-body">
                <table>
                    <tr>
                        <th>
                            <span style="display: inline-block; height: 77px; width: 130px">
                                <picture style="width: 100%; margin: auto;">
                                    <img src="{{AuthorImgSource}}" onclick="OpenInNewTab('{{ProfileURL}}');"
                                        style="display: inline-block; max-height: 100%; max-width: 100%; margin: auto;" />
                                </picture>
                                <br />
                                <a href="{{ProfileURL}}" target="_blank">{{Name}}</a>
                            </span>
                        </th>
                        <th style="width: 100%; margin: auto;">
                            <div>
                                <p class="card-text">
                                <div class="row">
                                    <div class="card col-md-5 text-center" style="margin: auto">
                                        <h6
                                            style="overflow: hidden; display: -webkit-box; text-overflow: ellipsis; -webkit-line-clamp: 1; -webkit-box-orient: vertical; color: black">
                                            {{Description}}
                                        </h6>
                                        <hr />
                                        <h6
                                            style="overflow: hidden; display: -webkit-box; text-overflow: ellipsis; -webkit-line-clamp: 1; -webkit-box-orient: vertical; color: black">
                                            {{Location}}
                                        </h6>

                                    </div>
                                    <div class="card col-md-2 text-center" style="margin: auto">
                                        <h6 style="color: rgb(24, 24, 24);" id="{{Follower_ID}}">
                                            Follower
                                            <hr />
                                        </h6>

                                    </div>
                                    <div class="card col-md-2 text-center" style="margin: auto">
                                        <h6 style="color: rgb(24, 24, 24);">
                                            Posts
                                            <hr />
                                            {{Posts}}
                                        </h6>

                                    </div>
                                    <div class="card col-md-2 text-center" style="margin: auto">
                                        <h6 style="color: rgb(24, 24, 24);" id="{{Following_ID}}">
                                            Following
                                            <hr />

                                        </h6>
                                    </div>
                                </div>
                                </p>
                            </div>
                        </th>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <footer class="footer">
        <div class="container">
            <nav>
                <ul>
                    <li>
                        <a href="https://hive.blog/@action-chain" target="_blank">
                            Action Chain
                        </a>
                    </li>
                    <li>
                        <a href="/about-us.html">
                            About Us
                        </a>
                    </li>
                    <li>
                        <a href="/de_impressum.html">
                            Impressum
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="copyright" id="copyright">
                &copy;
                <script>
                    document.getElementById('copyright').appendChild(document.createTextNode(new Date().getFullYear()))
                </script>, Coded by
                <a href="https://hive.blog/@action-chain" target="_blank">Action-Chain</a>.
            </div>
        </div>
    </footer>

    <!-- Settings Modal -->
<div class="modal fade" id="settigns_Modal" tabindex="-1" role="dialog" aria-labelledby="settigns_ModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settigns_ModalLabel">Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h6>ATTENTION: Any changes will be stored in your Cookies</h6>
          <hr />

              <!-- Post Explorer-->
              <h4>Where do you want to read the posts?</h4>
              <div class="btn-group">
                <button type="button" class="btn btn-success" id="btn_post_viewer">Hive</button>
                <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item" href="javascript: setSetting('post_viewer', 'Hive');">Hive</a>
                  <a class="dropdown-item" href="javascript: setSetting('post_viewer', 'PeakD');">PeakD</a>
                  <a class="dropdown-item" href="javascript: setSetting('post_viewer', 'LeoFinance');">LeoFinance</a>
                </div>
              </div>

              <hr />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@hivechain/hivejs/dist/hivejs.min.js"></script>

    <script src="assets/js/config.js" type="text/javascript"></script>
    <script src="assets/js/cookie-manager.js" type="text/javascript"></script>
    <!--   Core JS Files   -->
    <script src="assets/js/core/jquery.min.js" type="text/javascript"></script>
    <script src="assets/js/core/popper.min.js" type="text/javascript"></script>
    <script src="assets/js/core/bootstrap.min.js" type="text/javascript"></script>
    <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
    <script src="assets/js/plugins/bootstrap-switch.js"></script>
    <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
    <script src="assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
    <!--  Plugin for the DatePicker, full documentation here: https://github.com/uxsolutions/bootstrap-datepicker -->
    <script src="assets/js/plugins/bootstrap-datepicker.js" type="text/javascript"></script>
    <!-- Control Center for Now Ui Kit: parallax effects, scripts for the example pages etc -->
    <script src="assets/js/now-ui-kit.js" type="text/javascript"></script>

    <script type="text/javascript">
        var categories = [];
        var choosed_categories = [];
        var posts_wishes = true;

        window.addEventListener("load", load_categories);

        // Username checking
        var username;
        if (checkCookie("username") == false)
            {
                // Disable Feed and Account
                document.getElementById("nav_item_link_feed").style = "display: none";
                document.getElementById("nav_item_link_account").style = "display: none";
            }
        else {
            username = getCookie("username");
            // Update profiler
            $.ajax({
                url: SERVER_DOMAIN + "/ping",
                data: JSON.stringify({ "username": username }),
                contentType: 'application/json;charset=UTF-8',
                type: 'POST',
                success: function (response) {
                    if (response["status"] != "succes") {
                        console.log(response);
                        alert("Something went wrong!");
                    }
                },
                error: function (error) {
                    console.log(error);
                    alert("Something went wrong!");
                }
            });
        }

        function load_categories() {
            $.ajax({
                url: SERVER_DOMAIN + "/get_categories",
                data: JSON.stringify({}),
                contentType: 'application/json;charset=UTF-8',
                type: 'POST',
                success: function (response) {
                    if (response["status"] != "succes") {
                        console.log(response);
                        alert("Something went wrong!");
                        return;
                    }

                    categories = response["list"];

                    //set categories for zero
                    for (var i = 0; i < categories.length; i++) {
                        var item = document.createElement('a');
                        item.className = "dropdown-item";
                        item.href = "javascript:choose_category_dropdown('" + categories[i] + "');";
                        item.innerHTML = categories[i];

                        document.getElementById("dropdown_list_categories").appendChild(item);
                    }

                    //document.getElementById("setzero_interact").style = "";
                },
                error: function (error) {
                    console.log(error);
                    alert("Something went wrong!");
                }
            });
        }

        function choose_category_dropdown(value) {
            // Add element
            if (choosed_categories.length >= 10)
                return;

            for (var i = 0; i < choosed_categories.length; i++) {
                if (value == choosed_categories[i])
                    return;
            }

            choosed_categories.push(value);

            set_up_choosed_categories();
        }

        function remove_choosed_category(value) {
            var temp = [];
            for (var i = 0; i < choosed_categories.length; i++) {
                if (value != choosed_categories[i])
                    temp.push(choosed_categories[i]);
            }
            choosed_categories = temp;

            set_up_choosed_categories();
        }

        function set_up_choosed_categories() {
            get_data();
            document.getElementById("choosed_categories_first").innerHTML = "";
            document.getElementById("choosed_categories_second").innerHTML = "";

            for (var i = 0; i < choosed_categories.length; i++) {
                value = choosed_categories[i]
                var a = document.createElement("a");
                a.style = "color: blue;";
                a.href = "javascript: remove_choosed_category('" + value + "');";
                a.innerHTML = "  X";

                var h = document.createElement("h6");
                h.style = "color: black;";
                h.innerHTML += value;
                h.appendChild(a);

                var body = document.createElement("div");
                body.className = "card-body";
                body.appendChild(h);

                var container = document.createElement("div");
                container.className = "card col-md-2 text-center";
                container.style = "margin: auto";
                container.appendChild(body)

                if (i < 5)
                    document.getElementById("choosed_categories_first").appendChild(container);
                else
                    document.getElementById("choosed_categories_second").appendChild(container);
            }
        }

        function get_data() {
            if (choosed_categories.length < 2)
                return;

            document.getElementById("list").innerHTML = "";
            document.getElementById("lbl_cannot_find").style = "display: none";
            document.getElementById("loading_animation").style = "";

            var url = SERVER_DOMAIN + "/custom_search_by_category_";
            if (posts_wishes)
                url += "posts";
            else
                url += "author";

            $.ajax({
                url: url,
                data: JSON.stringify({ "cats": choosed_categories }),
                contentType: 'application/json;charset=UTF-8',
                type: 'POST',
                success: function (response) {
                    if (response["status"] != "succes") {
                        console.log(response);
                        alert("Something went wrong!");
                        return;
                    }
                    document.getElementById("loading_animation").style = "display: none";
                    //Succes, check how many

                    if (posts_wishes) {
                        posts = response["posts"]
                        if (posts.length == 0) {

                            document.getElementById("lbl_cannot_find").style = "";
                            return;
                        }

                        //Set them up
                      
                            set_post(posts);
                        
                    } else {
                        authors = response["authors"];
                        set_authors(authors);

                    }
                },
                error: function (error) {
                    console.log(error);
                    alert("Something went wrong at the server side. Please contact the support!");
                }
            });

        }

        function set_post(posts) {
            if (posts.length == 0)
                return;
        
            var author = posts[0][0];
            var permlink = posts[0][1];
            posts.shift();
            hivejs.api.getContent(author, permlink, function (err, result) {
                set_post(posts);
                if (result) {
                    var template = Handlebars.compile(document.getElementById('post_holder').innerHTML);
                    var metadata = JSON.parse(result['json_metadata']);

                    //body
                    div = document.createElement('div');
                    div.innerHTML = result["body"];
                    var body = process_markdown(result, div.innerText);

                    //image
                    var ImageSource = "";
                    try {
                        var images = metadata["image"];
                        if (images.length > 0)
                            ImageSource = images[0];
                    } catch { }

                    // URL
                    var hivURL = "https://hive.blog" + result["url"];
                    if (checkCookie("post_viewer")) {
                        var value = getCookie("post_viewer");

                        if (value == "PeakD")
                            hivURL = "https://peakd.com" + result["url"];
                        if (value == "LeoFinance")
                            hivURL = "https://leofinance.io" + result["url"];
                    }

                    var json = {
                        Title: result["title"],
                        Body: body,
                        ImageSource: ImageSource,
                        Author: result['author'],
                        HiveURL: hivURL
                    }

                    document.getElementById("list").innerHTML += template(json);
                    document.getElementById("loading_animation").style = "display: none";
                }
            });
        }

        function set_authors(authors) {
            if (authors.length == 0)
                return;

            author = authors[0][0]
            authors.shift();
            hivejs.api.getAccounts([author], function (err, result) {
                if (result) {
                    set_authors(authors);
                    if (result.length == 0)
                        return;

                    var template = Handlebars.compile(document.getElementById('author_holder').innerHTML);
                    obj = result[0];
                    var metadata = JSON.parse(obj['json_metadata'])["profile"];

                    var ProfileURL = "https://hive.blog/@" + obj["name"];
                    if (checkCookie("post_viewer")) {
                        var value = getCookie("post_viewer");

                        if (value == "PeakD")
                            ProfileURL = "https://peakd.com/@" + obj["name"];
                        if (value == "LeoFinance")
                            ProfileURL = "https://leofinance.io/@" + obj["name"];
                    }

                    var json = {
                        Name: metadata["name"],
                        Description: metadata["about"],
                        Location: metadata["location"],
                        ProfileURL: ProfileURL,
                        Posts: obj["post_count"] + " x",
                        Follower_ID: obj["name"] + "_follower_count",
                        Following_ID: obj["name"] + "_following_count",
                        AuthorImgSource: metadata["profile_image"]
                    }

                    document.getElementById("list").innerHTML += template(json);
                    document.getElementById("loading_animation").style = "display: none";

                    // Set Follow
                    hivejs.api.getFollowCount(obj["name"], function (err, result) {
                        if (result) {
                            document.getElementById(result["account"] + "_follower_count").innerHTML += result["following_count"];
                            document.getElementById(result["account"] + "_following_count").innerHTML += result["follower_count"];
                        }
                    });
                }

            });
        }

        function process_markdown(post, body) {
            try {
                metadata = JSON.parse(post['json_metadata']);

                //Remove brackets
                body = body.replace(/ *\[[^\]]*]/g, '');


                images = metadata["image"];
                for (var i = 0; i < images.length; i++) {
                    body = body.replace("!(" + images[i] + ")", '');
                }
                links = metadata["links"];
                for (var i = 0; i < links.length; i++) {
                    body = body.replace("(" + links[i] + ")", '');
                }

                while (body.indexOf("###") > -1)
                    body = body.replace("###", "##");

                while (body.indexOf("##") > -1)
                    body = body.replace("##", "");

                body = body.replace("\n\n\n", "\r")
            } catch { }
            return body;
        }

        function setup_wishes(p_wish) {
            if (p_wish == posts_wishes)
                return;

            if (p_wish) {
                posts_wishes = true;

                document.getElementById("btn_select_posts").className = "btn btn-round btn-info";
                document.getElementById("btn_select_authors").className = "btn btn-round btn-secondary";
            } else {
                posts_wishes = false;

                document.getElementById("btn_select_posts").className = "btn btn-round btn-secondary";
                document.getElementById("btn_select_authors").className = "btn btn-round btn-info";
            }
            get_data();
        }

        function OpenInNewTab(url) {
            var win = window.open(url, '_blank');
            win.focus();
        }
    
        function openSettingsModal() {
            if(checkCookie("post_viewer"))
                document.getElementById("btn_post_viewer").innerText = getCookie("post_viewer");

            $('#settigns_Modal').modal();
        }

        function setSetting(type, value){
            setCookie(type, value, 30);

            // Update
            get_data()
            openSettingsModal();
        }

    </script>
</body>

</html>